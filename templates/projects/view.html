{% extends "layout.html" %} 

{% block title %}
  View Project
{% endblock %}

{% block main %}
  <div class="d-flex align-items-center my-3">
    <div class="circle {{ 'bg-success' if project.is_open|int == 1 else 'bg-danger'}}"></div>
    <h3>{{ project.name }}</h3>
  </div>

  <p>
    Admin: {{ project.adminDisplayName }}
  </p>

  <p class="lead">
    {{ project.description }}
  </p>

  <div class="d-flex">
    <h3>Issues</h3>
    <button class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#issueModal">Create</button>
  </div>
  {% include "/partials/issues.html" %}
  
  <h3>Contributors</h3>
  <form id="contributorForm" class="d-flex mb-3">
    <input type="hidden" name="id" value="{{ project.id }}" />

    <select class="col-md-2" class="form-select" name="userId" disabled>
      <option value="">Select user...</option>
      {% for user in users %}
        <option value="{{ user.id }}">{{ user.userDisplayName }}</option>
      {% endfor %}
    </select>

    <button 
      type="submit"
      class="btn btn-primary"
      style="margin-left: 0.5em;" 
      disabled>Add Contributor</button>
  </form>

  <table id="contributorGrid" class="table table-striped table-hover">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Issues</th>
      </tr>
    </thead>

    <tbody>    
      {% for user in contributors %}
        <tr class="align-middle" data-id="{{ user.id }}">
          <td>{{ user.userDisplayName }}</td>
          <td><a href="/issues?q={{ user.username }}">View Issues</a></td>
        </tr>
      {% endfor%}
    </tbody>
  </table>

  <div class="d-flex justify-content-end">
    <button class="btn btn-danger" disabled>Delete Project</button>
  </div>

  {% if project["userIsAdmin"] %}
    <script>
      const contributorForm = document.querySelector('#contributorForm');

      contributorForm.querySelector("select").removeAttribute("disabled")
      contributorForm.querySelector("button[type='submit']").removeAttribute("disabled")

      contributorForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const projectId = e.target[0].value;
        const selectUser = e.target[1];

        const response = await fetch(`/projects/${projectId}/contributors`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId: selectUser.value }),
        });

        if (response.ok) {
          // add to grid
          const resJson = await response.json()
          addContributorToGrid(resJson[0]);

          // remove from select
          selectUser.remove(selectUser.selectedIndex)

        } else {
          const error = await response.json();
          alert(`Error: ${error.message}`)
        }
      });

      function addContributorToGrid({id, username, userDisplayName}) {
          var table = document.querySelector("#contributorGrid>tbody");
          var row = table.insertRow(0);
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          cell1.innerHTML = userDisplayName;
          cell2.innerHTML = `<a href="/issues?q=${username}">View Issues</a>`;
        }

    </script>
  {% endif %}
{% endblock %}
